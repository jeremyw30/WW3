<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Outils â€” Alliance NapolÃ©oniens</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header class="topbar">
  <div class="inner">
    <a href="index.html" class="brand" style="text-decoration:none; color:inherit; display:flex; align-items:center; cursor:pointer;">
      <img src="napo.png" alt="Logo Alliance" style="height:150px; margin-right:8px">
      <span style="display:flex; align-items:center; justify-content:center; height:150px; flex:1; font-size:42px; font-weight:900; color:#fbbf24; text-shadow:2px 2px 4px rgba(0,0,0,0.5); font-family:Georgia, serif; letter-spacing:1px">Alliance NapolÃ©oniens</span>
    </a>
    <div class="burger-menu" id="burgerMenu">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <nav id="nav">
      <div class="dropdown">
        <div class="dropdown-toggle">ğŸ“š Documentation</div>
        <div class="dropdown-menu">
          <a class="dropdown-item" href="infanterie.html">Infanterie</a>
          <a class="dropdown-item" href="blindes.html">BlindÃ©s</a>
          <a class="dropdown-item" href="soutien.html">Soutien</a>
          <a class="dropdown-item" href="missiles.html">Missiles</a>
          <a class="dropdown-item" href="chasseurs.html">Chasseurs</a>
          <a class="dropdown-item" href="bombardiers.html">Bombardiers</a>
          <a class="dropdown-item" href="naval.html">Naval</a>
        </div>
      </div>
      <div class="dropdown">
        <div class="dropdown-toggle">ğŸ“ Ã‰cole</div>
        <div class="dropdown-menu">
          <a class="dropdown-item" href="demande-prof.html">ğŸ‘¨â€ğŸ« Demande de prof</a>
          <a class="dropdown-item" href="idee1.html">ğŸ’¡ IdÃ©e 1</a>
          <a class="dropdown-item" href="idee2.html">ğŸ’¡ IdÃ©e 2</a>
        </div>
      </div>
      <a class="navlink" href="tactiques.html">ğŸ¯ Tactiques</a>
      <a class="navlink" href="guide.html">ğŸ“– Guide</a>
      <a class="navlink" href="communaute.html">ğŸ‘¥ CommunautÃ©</a>
      <a class="navlink active" href="outils.html">ğŸ§® Outils</a>
    </nav>
  </div>
</header>

<script>
const burger = document.getElementById('burgerMenu');
const nav = document.getElementById('nav');
if (burger && nav) {
  burger.addEventListener('click', () => {
    burger.classList.toggle('active');
    nav.classList.toggle('active');
  });
}

// Dropdown menus
const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
dropdownToggles.forEach(toggle => {
  toggle.addEventListener('click', (e) => {
    e.stopPropagation();
    const menu = toggle.nextElementSibling;
    document.querySelectorAll('.dropdown-menu').forEach(m => {
      if (m !== menu) m.classList.remove('show');
    });
    menu.classList.toggle('show');
  });
});
document.addEventListener('click', () => {
  document.querySelectorAll('.dropdown-menu').forEach(menu => {
    menu.classList.remove('show');
  });
});
</script>

<main class="container">
  <section class="hero">
    <div class="pad">
      <h1 class="h-title">ğŸ§® Calculateur de Combat</h1>
      <p class="h-sub">Simulez des batailles entre unitÃ©s et estimez les rÃ©sultats</p>
    </div>
  </section>

  <section style="margin-top:20px;">
    <div class="card">
      <div class="hd">
        <h2 style="margin:0; font-size:20px;">âš”ï¸ Configuration du Combat</h2>
      </div>
      <div class="bd" style="padding:20px;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:30px; margin-bottom:25px;">
          <!-- Attaquant -->
          <div>
            <h3 style="color:var(--danger); margin-bottom:15px;">ğŸ—¡ï¸ Attaquant</h3>
            <div style="margin-bottom:15px;">
              <label style="display:block; margin-bottom:5px; color:var(--muted); font-size:14px;">CatÃ©gorie</label>
              <select id="attackerCategory" onchange="loadAttackerUnits()" style="width:100%; padding:10px; background:var(--panel2); border:1px solid var(--line); border-radius:8px; color:var(--text); font-size:14px;">
                <option value="">SÃ©lectionner une catÃ©gorie</option>
                <option value="infanterie">Infanterie</option>
                <option value="blindÃ©s">BlindÃ©s</option>
                <option value="soutien">Soutien</option>
                <option value="missiles">Missiles</option>
                <option value="air">Aviation</option>
                <option value="mer">Naval</option>
              </select>
            </div>
            <div style="margin-bottom:15px;">
              <label style="display:block; margin-bottom:5px; color:var(--muted); font-size:14px;">UnitÃ©</label>
              <select id="attackerUnit" style="width:100%; padding:10px; background:var(--panel2); border:1px solid var(--line); border-radius:8px; color:var(--text); font-size:14px;">
                <option value="">Choisir d\'abord une catÃ©gorie</option>
              </select>
            </div>
            <div style="display:grid; grid-template-columns:2fr 1fr; gap:10px; margin-bottom:15px;">
              <div>
                <label style="display:block; margin-bottom:5px; color:var(--muted); font-size:14px;">Nombre d'unitÃ©s</label>
                <input type="number" id="attackerCount" value="10" min="1" style="width:100%; padding:10px; background:var(--panel2); border:1px solid var(--line); border-radius:8px; color:var(--text); font-size:14px;">
              </div>
              <div>
                <label style="display:block; margin-bottom:5px; color:var(--muted); font-size:14px;">Niveau</label>
                <input type="number" id="attackerLevel" value="1" min="1" max="10" style="width:100%; padding:10px; background:var(--panel2); border:1px solid var(--line); border-radius:8px; color:var(--text); font-size:14px;">
              </div>
            </div>
            <button onclick="addAttackerUnit()" class="btn" style="width:100%; padding:10px; font-size:14px; background:var(--danger);">+ Ajouter au Stack</button>
            <div id="attackerStack" style="margin-top:15px; padding:10px; background:var(--panel2); border-radius:8px; min-height:50px;"></div>
          </div>

          <!-- DÃ©fenseur -->
          <div>
            <h3 style="color:var(--ok); margin-bottom:15px;">ğŸ›¡ï¸ DÃ©fenseur</h3>
            <div style="margin-bottom:15px;">
              <label style="display:block; margin-bottom:5px; color:var(--muted); font-size:14px;">CatÃ©gorie</label>
              <select id="defenderCategory" onchange="loadDefenderUnits()" style="width:100%; padding:10px; background:var(--panel2); border:1px solid var(--line); border-radius:8px; color:var(--text); font-size:14px;">
                <option value="">SÃ©lectionner une catÃ©gorie</option>
                <option value="infanterie">Infanterie</option>
                <option value="blindÃ©s">BlindÃ©s</option>
                <option value="soutien">Soutien</option>
                <option value="missiles">Missiles</option>
                <option value="air">Aviation</option>
                <option value="mer">Naval</option>
              </select>
            </div>
            <div style="margin-bottom:15px;">
              <label style="display:block; margin-bottom:5px; color:var(--muted); font-size:14px;">UnitÃ©</label>
              <select id="defenderUnit" style="width:100%; padding:10px; background:var(--panel2); border:1px solid var(--line); border-radius:8px; color:var(--text); font-size:14px;">
                <option value="">Choisir d\'abord une catÃ©gorie</option>
              </select>
            </div>
            <div style="display:grid; grid-template-columns:2fr 1fr; gap:10px; margin-bottom:15px;">
              <div>
                <label style="display:block; margin-bottom:5px; color:var(--muted); font-size:14px;">Nombre d'unitÃ©s</label>
                <input type="number" id="defenderCount" value="10" min="1" style="width:100%; padding:10px; background:var(--panel2); border:1px solid var(--line); border-radius:8px; color:var(--text); font-size:14px;">
              </div>
              <div>
                <label style="display:block; margin-bottom:5px; color:var(--muted); font-size:14px;">Niveau</label>
                <input type="number" id="defenderLevel" value="1" min="1" max="10" style="width:100%; padding:10px; background:var(--panel2); border:1px solid var(--line); border-radius:8px; color:var(--text); font-size:14px;">
              </div>
            </div>
            <button onclick="addDefenderUnit()" class="btn" style="width:100%; padding:10px; font-size:14px; background:var(--ok);">+ Ajouter au Stack</button>
            <div id="defenderStack" style="margin-top:15px; padding:10px; background:var(--panel2); border-radius:8px; min-height:50px;"></div>
          </div>
        </div>

        <!-- Terrain -->
        <div style="margin-bottom:25px;">
          <label style="display:block; margin-bottom:5px; color:var(--muted); font-size:14px;">ğŸ—ºï¸ Type de terrain</label>
          <select id="terrain" style="width:100%; padding:10px; background:var(--panel2); border:1px solid var(--line); border-radius:8px; color:var(--text); font-size:14px;">
            <option value="degage">Terrain DÃ©gagÃ©</option>
            <option value="montagnes">Montagnes</option>
            <option value="forets">ForÃªts</option>
            <option value="urbain">Urbain</option>
            <option value="banlieue">Banlieue</option>
            <option value="jungle">Jungle</option>
            <option value="toundra">Toundra</option>
            <option value="desert">DÃ©sert</option>
            <option value="mer">Mer</option>
            <option value="aviation">Aviation</option>
          </select>
        </div>

        <button onclick="simulateCombat()" class="btn" style="width:100%; padding:15px; font-size:16px; font-weight:600;">âš”ï¸ Simuler le Combat</button>
      </div>
    </div>

    <!-- RÃ©sultats -->
    <div id="results" style="margin-top:20px; display:none;">
      <div class="card">
        <div class="hd">
          <h2 style="margin:0; font-size:20px;">ğŸ“Š RÃ©sultats de la Simulation</h2>
        </div>
        <div class="bd" style="padding:20px;">
          <div id="resultsContent"></div>
        </div>
      </div>
    </div>
  </section>

  <footer class="main-footer">
    <div class="footer-content">
      <div class="footer-col">
        <h3>Ã€ propos</h3>
        <p class="footer-text">
          Alliance NapolÃ©onienne sur Conflict of Nations WW3. Jouable sur mobile, tablette et PC. 
          84 membres actifs sur Discord. Rejoignez-nous pour lancer des parties entre membres !
        </p>
      </div>
      
      <div class="footer-col">
        <h3>Navigation</h3>
        <ul class="footer-links">
          <li><a href="index.html">Accueil</a></li>
          <li><a href="infanterie.html">ğŸª– Infanterie</a></li>
          <li><a href="blindes.html">ğŸ›¡ï¸ BlindÃ©s</a></li>
          <li><a href="soutien.html">ğŸ’£ Soutien</a></li>
          <li><a href="missiles.html">ğŸš€ Missiles</a></li>
          <li><a href="chasseurs.html">âœˆï¸ Chasseurs</a></li>
          <li><a href="bombardiers.html">ğŸ›©ï¸ Bombardiers</a></li>
          <li><a href="naval.html">âš“ Naval</a></li>
        </ul>
      </div>
      
      <div class="footer-col">
        <h3>CommunautÃ©</h3>
        <ul class="footer-links">
          <li><a href="https://discord.gg/z99qUe52PN" target="_blank">ğŸ’¬ Discord</a></li>
          <li><a href="#">ğŸ“§ Contact (lien Ã  ajouter)</a></li>
          <li><a href="login.html">ğŸ” Connexion Admin</a></li>
        </ul>
      </div>
      
      <div class="footer-col">
        <h3>Informations</h3>
        <ul class="footer-links">
          <li>ğŸ“… DerniÃ¨re MAJ : DÃ©c. 2025</li>
          <li>ğŸ® Jeu : Conflict of Nations WW3</li>
          <li>âš”ï¸ Alliance : Les NapolÃ©oniens</li>
        </ul>
      </div>
    </div>
    
    <div class="footer-bottom">
      Â© Alliance NapolÃ©oniens â€” dÃ©veloppÃ© par Jerem32 & dÃ©ployÃ© par Cloudflare Pages
      <span style="margin-left: 20px">|</span>
      <a href="admin.html" style="margin-left: 20px; color: var(--brand)">ğŸ” Admin</a>
      <span style="margin-left: 10px">|</span>
      <a href="#" id="openAdminModal" style="margin-left: 10px; color: var(--brand)">ğŸ‘¥ Ã‰quipe d'admin</a>
    </div>
  </footer>

  <div id="adminModal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <h2 style="color: var(--brand); margin-bottom: 20px;">ğŸ‘¥ Administrateurs</h2>
      <ul style="list-style: none; padding: 0;">
        <li style="padding: 15px; background: var(--panel2); margin-bottom: 10px; border-radius: 8px; border-left: 4px solid var(--brand);">
          <strong style="color: var(--brand)">1.</strong> YtbCrocomc
        </li>
        <li style="padding: 15px; background: var(--panel2); margin-bottom: 10px; border-radius: 8px; border-left: 4px solid var(--brand);">
          <strong style="color: var(--brand)">2.</strong> nicotena
        </li>
        <li style="padding: 15px; background: var(--panel2); margin-bottom: 10px; border-radius: 8px; border-left: 4px solid var(--brand);">
          <strong style="color: var(--brand)">3.</strong> PUFRUH
        </li>
      </ul>
      <a href="login.html" style="display: block; margin-top: 20px; padding: 12px; background: var(--brand); color: var(--bg); text-align: center; border-radius: 8px; text-decoration: none; font-weight: 600;">ğŸ” Connexion Admin</a>
    </div>
  </div>

  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      animation: fadeIn 0.3s;
    }

    .modal-content {
      background-color: var(--panel);
      margin: 10% auto;
      padding: 30px;
      border: 1px solid var(--line);
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      position: relative;
      animation: slideDown 0.3s;
    }

    .modal-close {
      color: var(--muted);
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: var(--brand);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @media (max-width: 768px) {
      .bd > div:first-child {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
</main>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzSjb1psqTLL5AqoWHAGNVDOWKPYAOXWJoT2dkV-NzS_aSWBdKKIjXXTAhgN5lUBVTV/exec";
  let unitsData = [];
  let attackerStack = [];
  let defenderStack = [];

  // Charger les donnÃ©es au chargement de la page
  window.addEventListener('DOMContentLoaded', async () => {
    try {
      const response = await fetch(API_URL);
      const data = await response.json();
      unitsData = data;
      console.log('DonnÃ©es chargÃ©es depuis l\'API:', unitsData);
      console.log('Nombre d\'unitÃ©s:', unitsData.length);
      if (unitsData.length > 0) {
        console.log('Exemple de premiÃ¨re unitÃ©:', unitsData[0]);
        console.log('ClÃ©s disponibles:', Object.keys(unitsData[0]));
      }
    } catch (error) {
      console.error("Erreur lors du chargement des unitÃ©s:", error);
    }
  });

  const modal = document.getElementById('adminModal');
  const openBtn = document.getElementById('openAdminModal');
  const closeBtn = document.querySelector('.modal-close');

  if (openBtn && modal && closeBtn) {
    openBtn.onclick = function(e) {
      e.preventDefault();
      modal.style.display = 'block';
    }

    closeBtn.onclick = function() {
      modal.style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }
  }

  function loadAttackerUnits() {
    const category = document.getElementById('attackerCategory').value;
    const unitSelect = document.getElementById('attackerUnit');
    
    if (!category) {
      unitSelect.innerHTML = '<option value="">Choisir d\'abord une catÃ©gorie</option>';
      return;
    }

    console.log('CatÃ©gorie sÃ©lectionnÃ©e:', category);
    console.log('DonnÃ©es disponibles:', unitsData);

    const filteredUnits = unitsData.filter(unit => {
      const unitCat = String(unit.Categorie || '').trim().toLowerCase();
      return unitCat === category.toLowerCase();
    });
    
    console.log('UnitÃ©s filtrÃ©es:', filteredUnits);
    
    unitSelect.innerHTML = '<option value="">SÃ©lectionner une unitÃ©</option>';
    filteredUnits.forEach(unit => {
      const nom = String(unit["UnitÃ©"] || unit.nom || '').trim();
      const puissance = unit.puissance || unit.attaque || unit.Puissance || unit.Attaque || 100;
      const defense = unit.defense || unit.Defense || unit.DÃ©fense || 80;
      
      const option = document.createElement('option');
      option.value = JSON.stringify({
        nom: nom,
        puissance: puissance,
        defense: defense
      });
      option.textContent = `${nom} (Att: ${puissance}, Def: ${defense})`;
      unitSelect.appendChild(option);
    });
  }

  function addAttackerUnit() {
    const unitSelect = document.getElementById('attackerUnit');
    const countInput = document.getElementById('attackerCount');
    const levelInput = document.getElementById('attackerLevel');
    
    if (!unitSelect.value) {
      alert('Veuillez sÃ©lectionner une unitÃ©');
      return;
    }

    const unit = JSON.parse(unitSelect.value);
    const count = parseInt(countInput.value);
    const level = parseInt(levelInput.value);

    if (count <= 0) {
      alert('Le nombre d\'unitÃ©s doit Ãªtre supÃ©rieur Ã  0');
      return;
    }

    if (level < 1 || level > 10) {
      alert('Le niveau doit Ãªtre entre 1 et 10');
      return;
    }

    attackerStack.push({
      ...unit,
      count: count,
      level: level
    });

    updateStackDisplay('attacker');
  }

  function addDefenderUnit() {
    const unitSelect = document.getElementById('defenderUnit');
    const countInput = document.getElementById('defenderCount');
    const levelInput = document.getElementById('defenderLevel');
    
    if (!unitSelect.value) {
      alert('Veuillez sÃ©lectionner une unitÃ©');
      return;
    }

    const unit = JSON.parse(unitSelect.value);
    const count = parseInt(countInput.value);
    const level = parseInt(levelInput.value);

    if (count <= 0) {
      alert('Le nombre d\'unitÃ©s doit Ãªtre supÃ©rieur Ã  0');
      return;
    }

    if (level < 1 || level > 10) {
      alert('Le niveau doit Ãªtre entre 1 et 10');
      return;
    }

    defenderStack.push({
      ...unit,
      count: count,
      level: level
    });

    updateStackDisplay('defender');
  }

  function removeFromStack(side, index) {
    if (side === 'attacker') {
      attackerStack.splice(index, 1);
      updateStackDisplay('attacker');
    } else {
      defenderStack.splice(index, 1);
      updateStackDisplay('defender');
    }
  }

  function updateStackDisplay(side) {
    const stack = side === 'attacker' ? attackerStack : defenderStack;
    const container = document.getElementById(side + 'Stack');
    
    if (stack.length === 0) {
      container.innerHTML = '<p style="color:var(--muted); font-size:13px; margin:0;">Aucune unitÃ© ajoutÃ©e</p>';
      return;
    }

    container.innerHTML = stack.map((unit, index) => `
      <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:var(--panel); border-radius:6px; margin-bottom:8px; border-left:3px solid ${side === 'attacker' ? 'var(--danger)' : 'var(--ok)'};">
        <div>
          <strong style="color:var(--text);">${unit.nom}</strong>
          <span style="color:var(--muted); font-size:12px; margin-left:10px;">x${unit.count}</span>
          <span style="color:var(--brand); font-size:12px; margin-left:10px;">â­Niv.${unit.level}</span>
          <span style="color:var(--muted); font-size:12px; margin-left:10px;">(Att:${unit.puissance} / Def:${unit.defense})</span>
        </div>
        <button onclick="removeFromStack('${side}', ${index})" style="background:var(--danger); border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">Ã—</button>
      </div>
    `).join('');
  }

  function loadDefenderUnits() {
    const category = document.getElementById('defenderCategory').value;
    const unitSelect = document.getElementById('defenderUnit');
    
    if (!category) {
      unitSelect.innerHTML = '<option value="">Choisir d\'abord une catÃ©gorie</option>';
      return;
    }

    console.log('CatÃ©gorie sÃ©lectionnÃ©e:', category);
    console.log('DonnÃ©es disponibles:', unitsData);

    const filteredUnits = unitsData.filter(unit => {
      const unitCat = String(unit.Categorie || '').trim().toLowerCase();
      return unitCat === category.toLowerCase();
    });
    
    console.log('UnitÃ©s filtrÃ©es:', filteredUnits);
    
    unitSelect.innerHTML = '<option value="">SÃ©lectionner une unitÃ©</option>';
    filteredUnits.forEach(unit => {
      const nom = String(unit["UnitÃ©"] || unit.nom || '').trim();
      const puissance = unit.puissance || unit.attaque || unit.Puissance || unit.Attaque || 100;
      const defense = unit.defense || unit.Defense || unit.DÃ©fense || 80;
      
      const option = document.createElement('option');
      option.value = JSON.stringify({
        nom: nom,
        puissance: puissance,
        defense: defense
      });
      option.textContent = `${nom} (Att: ${puissance}, Def: ${defense})`;
      unitSelect.appendChild(option);
    });
  }

  function simulateCombat() {
    // VÃ©rifier qu'il y a des unitÃ©s dans les stacks
    if (attackerStack.length === 0) {
      alert("Veuillez ajouter au moins une unitÃ© attaquante au stack.");
      return;
    }

    if (defenderStack.length === 0) {
      alert("Veuillez ajouter au moins une unitÃ© dÃ©fenseure au stack.");
      return;
    }

    const terrain = document.getElementById('terrain').value;

    // Modificateurs de terrain
    let defenseBonus = 1;
    let terrainName = "Terrain DÃ©gagÃ©";
    
    switch(terrain) {
      case 'urbain':
        defenseBonus = 1.2;
        terrainName = "Urbain";
        break;
      case 'montagnes':
        defenseBonus = 1.3;
        terrainName = "Montagnes";
        break;
      case 'forets':
        defenseBonus = 1.15;
        terrainName = "ForÃªts";
        break;
      case 'banlieue':
        defenseBonus = 1.1;
        terrainName = "Banlieue";
        break;
      case 'jungle':
        defenseBonus = 1.15;
        terrainName = "Jungle";
        break;
      case 'toundra':
        defenseBonus = 1.0;
        terrainName = "Toundra";
        break;
      case 'desert':
        defenseBonus = 0.95;
        terrainName = "DÃ©sert";
        break;
      case 'mer':
        defenseBonus = 1.0;
        terrainName = "Mer";
        break;
      case 'aviation':
        defenseBonus = 1.0;
        terrainName = "Aviation";
        break;
    }

    // Calculer les puissances totales avec modificateur de niveau (+5% par niveau)
    const totalAttackPower = attackerStack.reduce((sum, unit) => {
      const levelBonus = 1 + ((unit.level - 1) * 0.05);
      return sum + (unit.count * unit.puissance * levelBonus);
    }, 0);
    const totalDefensePower = defenderStack.reduce((sum, unit) => {
      const levelBonus = 1 + ((unit.level - 1) * 0.05);
      return sum + (unit.count * unit.defense * defenseBonus * levelBonus);
    }, 0);
    const totalAttackerCount = attackerStack.reduce((sum, unit) => sum + unit.count, 0);
    const totalDefenderCount = defenderStack.reduce((sum, unit) => sum + unit.count, 0);
    
    // Ratio d'efficacitÃ©
    const attackEfficiency = totalAttackPower / (totalDefensePower + 1);
    const defenseEfficiency = totalDefensePower / (totalAttackPower + 1);

    // Calculer les pertes pour chaque type d'unitÃ©
    const attackerResults = attackerStack.map(unit => {
      const losses = Math.min(unit.count, Math.round(unit.count * defenseEfficiency * 0.5));
      return {
        ...unit,
        losses: losses,
        survivors: unit.count - losses
      };
    });

    const defenderResults = defenderStack.map(unit => {
      const losses = Math.min(unit.count, Math.round(unit.count * attackEfficiency * 0.7));
      return {
        ...unit,
        losses: losses,
        survivors: unit.count - losses
      };
    });

    // Calculer les totaux
    const totalAttackerLosses = attackerResults.reduce((sum, u) => sum + u.losses, 0);
    const totalDefenderLosses = defenderResults.reduce((sum, u) => sum + u.losses, 0);
    const totalAttackerSurvivors = attackerResults.reduce((sum, u) => sum + u.survivors, 0);
    const totalDefenderSurvivors = defenderResults.reduce((sum, u) => sum + u.survivors, 0);

    // DÃ©terminer le vainqueur
    let winner = "";
    let winnerColor = "";
    
    if (totalAttackerSurvivors > totalDefenderSurvivors * 1.5) {
      winner = "Victoire de l'Attaquant";
      winnerColor = "var(--danger)";
    } else if (totalDefenderSurvivors > totalAttackerSurvivors * 1.5) {
      winner = "Victoire du DÃ©fenseur";
      winnerColor = "var(--ok)";
    } else if (totalAttackerSurvivors > totalDefenderSurvivors) {
      winner = "Victoire SerrÃ©e de l'Attaquant";
      winnerColor = "var(--warn)";
    } else if (totalDefenderSurvivors > totalAttackerSurvivors) {
      winner = "Victoire SerrÃ©e du DÃ©fenseur";
      winnerColor = "var(--warn)";
    } else {
      winner = "Ã‰galitÃ© / Combat IndÃ©cis";
      winnerColor = "var(--muted)";
    }

    // Afficher les rÃ©sultats
    const resultsDiv = document.getElementById('results');
    const resultsContent = document.getElementById('resultsContent');
    
    resultsContent.innerHTML = `
      <div style="text-align:center; padding:20px; background:var(--panel2); border-radius:12px; margin-bottom:20px;">
        <h3 style="font-size:28px; margin:0; color:${winnerColor};">${winner}</h3>
        <p style="color:var(--muted); margin-top:5px;">Terrain: ${terrainName}</p>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
        <div style="padding:20px; background:rgba(251,113,133,0.1); border:2px solid var(--danger); border-radius:12px;">
          <h4 style="color:var(--danger); margin:0 0 15px 0;">ğŸ—¡ï¸ Stack Attaquant</h4>
          <div style="margin-bottom:15px;">
            ${attackerResults.map(unit => `
              <div style="padding:8px; background:var(--panel2); border-radius:6px; margin-bottom:8px;">
                <div style="font-weight:bold; margin-bottom:4px;">${unit.nom} <span style="color:var(--brand); font-size:12px;">â­Niv.${unit.level}</span></div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; font-size:13px;">
                  <div><span style="color:var(--muted);">Initial:</span> ${unit.count}</div>
                  <div><span style="color:var(--danger);">Pertes:</span> -${unit.losses}</div>
                  <div><span style="color:var(--brand);">Restant:</span> ${unit.survivors}</div>
                </div>
              </div>
            `).join('')}
          </div>
          <div style="padding-top:15px; border-top:2px solid var(--line);">
            <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:16px;">
              <span>TOTAL:</span>
              <span style="color:var(--brand);">${totalAttackerSurvivors} / ${totalAttackerCount}</span>
            </div>
          </div>
        </div>

        <div style="padding:20px; background:rgba(52,211,153,0.1); border:2px solid var(--ok); border-radius:12px;">
          <h4 style="color:var(--ok); margin:0 0 15px 0;">ğŸ›¡ï¸ Stack DÃ©fenseur</h4>
          <div style="margin-bottom:15px;">
            ${defenderResults.map(unit => `
              <div style="padding:8px; background:var(--panel2); border-radius:6px; margin-bottom:8px;">
                <div style="font-weight:bold; margin-bottom:4px;">${unit.nom} <span style="color:var(--brand); font-size:12px;">â­Niv.${unit.level}</span></div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; font-size:13px;">
                  <div><span style="color:var(--muted);">Initial:</span> ${unit.count}</div>
                  <div><span style="color:var(--danger);">Pertes:</span> -${unit.losses}</div>
                  <div><span style="color:var(--brand);">Restant:</span> ${unit.survivors}</div>
                </div>
              </div>
            `).join('')}
          </div>
          <div style="padding-top:15px; border-top:2px solid var(--line);">
            <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:16px;">
              <span>TOTAL:</span>
              <span style="color:var(--brand);">${totalDefenderSurvivors} / ${totalDefenderCount}</span>
            </div>
          </div>
        </div>
      </div>

      <div style="padding:15px; background:var(--panel2); border-radius:8px; border-left:4px solid var(--brand);">
        <p style="margin:0; font-size:13px; color:var(--muted); font-style:italic;">
          âš ï¸ Cette simulation est approximative et basÃ©e sur des calculs simplifiÃ©s. 
          Les rÃ©sultats rÃ©els peuvent varier selon les doctrines, niveaux d'unitÃ©s et autres facteurs du jeu.
        </p>
      </div>
    `;

    resultsDiv.style.display = 'block';
    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
</script>
</body>
</html>
